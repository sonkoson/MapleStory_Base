importPackage(Packages.database);
importPackage(java.lang);

var enter = "\r\n";
var status = -1;
var step = -1;

var targetName = "";
var promoCount = 0;

// â€» ì—¬ëŸ¬ë¶„ í™˜ê²½ì— ë§ê²Œ ë°˜ë“œì‹œ ìˆ˜ì •í•˜ì„¸ìš”. (HeidiSQLì—ì„œ ë³´ê³  ìˆëŠ” ì‹¤ì œ DB ìŠ¤í‚¤ë§ˆëª…)
var DB_SCHEMA = "ganglim";  // ì˜ˆ: "ganglim", "mydb" ë“±

function start() {
    status = -1;
    action(1, 0, 0);
}

function action(mode, type, sel) {
    if (mode == 1) {
        status++;
    } else {
        cm.dispose();
        return;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 0) ì²« ëŒ€í™”: â€œìœ ì € ë‹‰ë„¤ì„ì„ ì…ë ¥ë°›ê¸°â€
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (status == 0) {
        // GM ê¶Œí•œ ì²´í¬
        if (!cm.getPlayer().isGM()) {
            cm.sendOk("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            cm.dispose();
            return;
        }
        cm.sendGetText(
            "#fs12#<GM ì „ìš© í™ë³´ ê¸°ë¡ ë‚¨ê¸°ê¸°>#fs11#" + enter +
            "1) í™ë³´ íšŸìˆ˜ë¥¼ ê¸°ë¡í•  ìœ ì €ì˜ ë‹‰ë„¤ì„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”:\n\n" +
            "(ì˜ˆ: í™ë³´ë°›ì„ìœ ì €ë‹‰ë„¤ì„)"
        );
        step = 1;
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) ë‹‰ë„¤ì„ ì…ë ¥ í›„ â†’ â€œí™ë³´ íšŸìˆ˜ ì…ë ¥ë°›ê¸°â€
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else if (status == 1) {
        if (step != 1) {
            cm.sendOk("ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            cm.dispose();
            return;
        }
        targetName = cm.getText().trim();
        if (targetName.length < 1) {
            cm.sendOk("ìœ íš¨í•œ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            cm.dispose();
            return;
        }
        cm.sendGetText(
            "ğŸ”¹ [" + targetName + "] ë‹˜ì—ê²Œ ê¸°ë¡í•  í™ë³´ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\n" +
            "(ì˜ˆ: 3)"
        );
        step = 2;
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) í™ë³´ íšŸìˆ˜ ì…ë ¥ í›„ â†’ ì‹¤ì œ INSERT ì²˜ë¦¬
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else if (status == 2) {
        if (step != 2) {
            cm.sendOk("ì˜ˆìƒì¹˜ ëª»í•œ íë¦„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            cm.dispose();
            return;
        }
        var txt = cm.getText().trim();
        if (!/^\d+$/.test(txt)) {
            cm.sendOk("ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            cm.dispose();
            return;
        }
        promoCount = parseInt(txt);
        if (promoCount <= 0) {
            cm.sendOk("í™ë³´ íšŸìˆ˜ëŠ” 1íšŒ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
            cm.dispose();
            return;
        }

        // GM ê¶Œí•œ ì¬í™•ì¸
        if (!cm.getPlayer().isGM()) {
            cm.sendOk("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            cm.dispose();
            return;
        }

        // ì´ì œ DBì— INSERT
        insertHongboRecord(targetName, promoCount);
        return;
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ê·¸ ì™¸ì˜ status ê°’ì´ë©´ ì¢…ë£Œ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else {
        cm.dispose();
    }
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í•¨ìˆ˜: hongbo í…Œì´ë¸”ì— ìƒˆë¡œìš´ â€œí™ë³´ ê¸°ë¡â€ì„ ë‚¨ê¸°ëŠ” ì‹¤ì œ DB ì²˜ë¦¬
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function insertHongboRecord(nickname, count) {
    var con    = null;
    var ps     = null, rs    = null;
    var psIns  = null;
    try {
        con = DBConnection.getConnection();

        // 1) INSERT ì‹œ ì‚¬ìš©í•  ìºë¦­í„° ID(cId)ë¥¼ ì°¾ê¸° ìœ„í•´, characters í…Œì´ë¸” ì¡°íšŒ
        ps = con.prepareStatement(
            "SELECT id FROM " + DB_SCHEMA + ".characters WHERE name = ?"
        );
        ps.setString(1, nickname);
        rs = ps.executeQuery();
        if (!rs.next()) {
            // í•´ë‹¹ ë‹‰ë„¤ì„ì˜ ìºë¦­í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
            rs.close();
            ps.close();
            cm.sendOk("DBì—ì„œ [" + nickname + "] ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            cm.dispose();
            return;
        }
        var charId = rs.getInt("id");
        rs.close();
        ps.close();

        // 2) í™ë³´ í¬ì¸íŠ¸(etc) ê³„ì‚° (ì˜ˆ: íšŒë‹¹ 50,000P)
        var pointValue = count * 50000;

        // 3) hongbo í…Œì´ë¸”ì— INSERT
        //    â†’ date ì»¬ëŸ¼ì—ëŠ” MySQL NOW() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ì„œë²„ ì‹œê°ì„ ìë™ìœ¼ë¡œ ë„£ìŒ
        psIns = con.prepareStatement(
            "INSERT INTO " + DB_SCHEMA + ".hongbo " +
            "(`name`, `check`, `youtube`, `blog`, `etc`, `comment`, `date`, `cid`) " +
            "VALUES (?, 0, 0, ?, ?, '', NOW(), ?)"
        );
        psIns.setString(1, nickname);        // name
        psIns.setInt(2, count);              // blog = í™ë³´ íšŸìˆ˜
        psIns.setInt(3, pointValue);         // etc  = í™ë³´ í¬ì¸íŠ¸
        psIns.setInt(4, charId);             // cid  = characterId

        var inserted = psIns.executeUpdate();
        psIns.close();

        if (inserted > 0) {
            cm.sendOk(
                "#fs11#â–¶ GM í™ë³´ ê¸°ë¡ì´ DBì— ì •ìƒ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\r\n\r\n" +
                "   ë‹‰ë„¤ì„ : " + nickname + enter +
                "   í™ë³´ íšŸìˆ˜ : " + count + " íšŒ" + enter +
                "   ì§€ê¸‰ ì˜ˆì • í™ë³´ í¬ì¸íŠ¸ : " + pointValue.toLocaleString() + "P" + enter +
                "   characterId (cid) : " + charId + enter +
                "   ë“±ë¡ ì‹œê° (DBì„œë²„ í˜„ì¬ ì‹œê°) : NOW()"
            );
        } else {
            cm.sendOk("ì˜¤ë¥˜: ë ˆì½”ë“œê°€ í•œ ê±´ë„ ì‚½ì…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
        cm.dispose();
        return;

    } catch (e) {
        cm.sendOk("í™ë³´ ê¸°ë¡ì„ DBì— ë‚¨ê¸°ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\r\n" + e.toString());
        e.printStackTrace();
        try {
            if (con != null && !con.isClosed()) con.close();
        } catch (ex) {
            ex.printStackTrace();
        }
        cm.dispose();
        return;
    } finally {
        try { if (rs  != null && !rs.isClosed())  rs.close();  } catch(e2) {}
        try { if (ps  != null && !ps.isClosed())  ps.close();  } catch(e2) {}
        try { if (con != null && !con.isClosed()) con.close(); } catch(e2) {}
    }
}
